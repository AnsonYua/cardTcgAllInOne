{
  "gameId": "utility_final_calculation_test",
  "description": "Test sp-6 (DeepSeek風暴) totalPowerNerf effect applied after combo calculation",
  "testType": "dynamic",
  "initialGameEnv": {
    "phase": "MAIN_PHASE",
    "round": 1,
    "gameStarted": true,
    "currentPlayer": "playerId_1",
    "currentTurn": 0,
    "firstPlayer": 0,
    "players": {
      "playerId_1": {
        "id": "playerId_1",
        "name": "Player 1",
        "deck": {
          "hand": ["sp-6", "c-1", "c-2", "h-1", "c-3"],
          "mainDeck": ["c-4", "c-5", "c-6", "c-7", "c-8", "c-9", "c-10", "c-11", "c-12", "c-13", "c-14", "c-15", "h-2", "h-3", "h-4", "sp-2", "sp-3"],
          "leader": ["s-1", "s-2", "s-3", "s-4"],
          "currentLeaderIdx": 0
        },
        "isReady": true,
        "redraw": 1,
        "turnAction": [],
        "playerPoint": 0
      },
      "playerId_2": {
        "id": "playerId_2",
        "name": "Player 2",
        "deck": {
          "hand": ["sp-1", "c-21", "c-22", "h-5", "c-23"],
          "mainDeck": ["c-24", "c-25", "c-26", "c-27", "c-28", "c-3", "c-4", "c-5", "c-6", "c-7", "c-8", "c-9", "h-6", "h-7", "h-8", "sp-7", "sp-8"],
          "leader": ["s-2", "s-3", "s-4", "s-5"],
          "currentLeaderIdx": 0
        },
        "isReady": true,
        "redraw": 1,
        "turnAction": [],
        "playerPoint": 0
      }
    },
    "zones": {
      "playerId_1": {
        "leader": {
          "id": "s-1",
          "name": "特朗普",
          "cardType": "leader",
          "gameType": "愛國者",
          "initialPoint": 100,
          "level": 6,
          "rarity": "legendary",
          "zoneCompatibility": {
            "top": ["右翼", "自由", "經濟"],
            "left": ["右翼", "自由", "愛國者"],
            "right": ["右翼", "愛國者", "經濟"]
          },
          "effects": {
            "description": "我方場上右翼或愛國者類型的角色卡 原能力值加 +45",
            "rules": [
              {
                "id": "trump_power_boost",
                "type": "continuous",
                "trigger": {
                  "event": "always",
                  "conditions": []
                },
                "target": {
                  "owner": "self",
                  "zones": ["top", "left", "right"],
                  "filters": [
                    {
                      "type": "gameTypeOr",
                      "values": ["右翼", "愛國者"]
                    }
                  ]
                },
                "effect": {
                  "type": "powerBoost",
                  "value": 45
                }
              }
            ]
          }
        },
        "top": [],
        "left": [],
        "right": [],
        "help": [],
        "sp": []
      },
      "playerId_2": {
        "leader": {
          "id": "s-2",
          "name": "拜登",
          "cardType": "leader",
          "gameType": "左翼",
          "initialPoint": 100,
          "level": 7,
          "rarity": "legendary",
          "zoneCompatibility": {
            "top": ["左翼", "自由", "經濟", "右翼", "愛國者"],
            "left": ["左翼", "自由", "經濟", "右翼", "愛國者"],
            "right": ["左翼", "自由", "經濟", "右翼", "愛國者"]
          },
          "effects": {
            "description": "全部召喚出來的角色能力值 +40",
            "rules": [
              {
                "id": "biden_all_boost",
                "type": "continuous",
                "trigger": {
                  "event": "always",
                  "conditions": []
                },
                "target": {
                  "owner": "self",
                  "zones": ["top", "left", "right"],
                  "filters": []
                },
                "effect": {
                  "type": "powerBoost",
                  "value": 40
                }
              }
            ]
          }
        },
        "top": [],
        "left": [],
        "right": [],
        "help": [],
        "sp": []
      }
    },
    "gameEvents": [],
    "lastEventId": 1,
    "pendingPlayerAction": null,
    "pendingCardSelections": {},
    "playSequence": {
      "globalSequence": 0,
      "plays": []
    },
    "computedState": {
      "playerPowers": {},
      "activeRestrictions": {},
      "disabledCards": [],
      "victoryPointModifiers": {}
    }
  },
  "playerActions": [
    {
      "step": 1,
      "description": "Player 1 places c-2 (前總統特朗普) in LEFT zone",
      "playerId": "playerId_1",
      "action": {
        "actionType": "PlayCard",
        "cardId": "c-2",
        "zone": "left"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "c-2 receives +45 power from Trump leader (右翼 type)",
        "c-2 provides +10 boost to 右翼 type cards (including self)"
      ]
    },
    {
      "step": 2,
      "description": "Player 2 places c-21 (奧巴馬) in TOP zone",
      "playerId": "playerId_2",
      "action": {
        "actionType": "PlayCard",
        "cardId": "c-21",
        "zone": "top"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "c-21 provides +50 single target boost (targets c-2)",
        "c-21 receives +40 power from Biden leader"
      ]
    },
    {
      "step": 3,
      "description": "Player 1 places c-1 (總統特朗普) in RIGHT zone",
      "playerId": "playerId_1",
      "action": {
        "actionType": "PlayCard",
        "cardId": "c-1",
        "zone": "right"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "c-1 receives +45 power from Trump leader (愛國者 type)",
        "c-1 provides +10 boost to 特朗普家族 trait cards (including self and c-2)"
      ]
    },
    {
      "step": 4,
      "description": "Player 2 places c-22 in LEFT zone",
      "playerId": "playerId_2",
      "action": {
        "actionType": "PlayCard",
        "cardId": "c-22",
        "zone": "left"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "c-22 receives +40 power from Biden leader"
      ]
    },
    {
      "step": 5,
      "description": "Player 1 places c-3 in TOP zone",
      "playerId": "playerId_1",
      "action": {
        "actionType": "PlayCard",
        "cardId": "c-3",
        "zone": "top"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "c-3 receives +45 power from Trump leader (右翼 type)",
        "c-3 receives +10 boost from c-2 (右翼 type boost)"
      ]
    },
    {
      "step": 6,
      "description": "Player 2 places c-23 in RIGHT zone",
      "playerId": "playerId_2",
      "action": {
        "actionType": "PlayCard",
        "cardId": "c-23",
        "zone": "right"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "c-23 receives +40 power from Biden leader"
      ]
    },
    {
      "step": 7,
      "description": "Player 1 places h-1 (Deep State) in HELP zone",
      "playerId": "playerId_1",
      "action": {
        "actionType": "PlayCard",
        "cardId": "h-1",
        "zone": "help"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "h-1 neutralizes opponent Help and SP effects"
      ]
    },
    {
      "step": 8,
      "description": "Player 2 places h-5 (失智老人) in HELP zone",
      "playerId": "playerId_2",
      "action": {
        "actionType": "PlayCard",
        "cardId": "h-5",
        "zone": "help"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "h-5 power boost neutralized by h-1",
        "h-5 zone freedom remains due to immunity"
      ]
    },
    {
      "step": 9,
      "description": "Player 1 places sp-6 (DeepSeek風暴) face-down in SP zone",
      "playerId": "playerId_1",
      "action": {
        "actionType": "PlayCardBack",
        "cardId": "sp-6",
        "zone": "sp"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "sp-6 placed face-down in SP zone",
        "sp-6 totalPowerNerf effect will apply after combo calculation"
      ]
    },
    {
      "step": 10,
      "description": "Player 2 places sp-1 (天選之人) face-down in SP zone",
      "playerId": "playerId_2",
      "action": {
        "actionType": "PlayCardBack",
        "cardId": "sp-1",
        "zone": "sp"
      },
      "expectedResult": {
        "success": true,
        "noError": true,
        "cardPlaced": true
      },
      "expectedEffects": [
        "sp-1 placed face-down in SP zone",
        "All zones filled, triggers battle calculation"
      ]
    }
  ],
  "expectedStateChanges": {
    "zones.playerId_1.top.length": 1,
    "zones.playerId_1.left.length": 1,
    "zones.playerId_1.right.length": 1,
    "zones.playerId_1.help.length": 1,
    "zones.playerId_1.sp.length": 1,
    "zones.playerId_2.top.length": 1,
    "zones.playerId_2.left.length": 1,
    "zones.playerId_2.right.length": 1,
    "zones.playerId_2.help.length": 1,
    "zones.playerId_2.sp.length": 1,
    "phase": "BATTLE_PHASE",
    "playSequence.plays.length": 10
  },
  "validationPoints": {
    "power_calculation_before_final_effects": {
      "description": "Power calculation before final effects (with combos)",
      "expected": {
        "player1BasePower": 525,
        "player1ComboBonus": 150,
        "player1TotalBeforeFinal": 675,
        "player2BasePower": 265,
        "player2ComboBonus": 0,
        "player2TotalBeforeFinal": 265
      },
      "powerBreakdown": {
        "player1": {
          "c2Power": 145,
          "c1Power": 165,
          "c3Power": 115,
          "totalBasePower": 525,
          "comboBonus": 150,
          "note": "Two 右翼 cards (c-2, c-3) + one 愛國者 card (c-1) = 右翼+愛國者combo"
        },
        "player2": {
          "c21Power": 120,
          "c22Power": 60,
          "c23Power": 65,
          "totalBasePower": 265,
          "comboBonus": 0,
          "note": "No combo bonuses (different types: 左翼, 左翼, 經濟)"
        }
      }
    },
    "final_calculation_effects": {
      "description": "Final calculation with totalPowerNerf applied",
      "expected": {
        "player1FinalPower": 675,
        "player2FinalPowerBeforeNerf": 265,
        "player2FinalPowerAfterNerf": 185,
        "totalPowerNerfApplied": 80
      },
      "calculation": {
        "player1": "525 base + 150 combo = 675 (no nerf)",
        "player2": "265 base + 0 combo - 80 nerf = 185",
        "winner": "Player 1 (675 > 185)"
      }
    },
    "sp_effect_execution_order": {
      "description": "SP effects execute in priority order (Trump > Biden)",
      "expected": {
        "executionOrder": ["sp-6", "sp-1"],
        "sp6Priority": 100,
        "sp1Priority": 100,
        "tiebreaker": "firstPlayer"
      }
    }
  },
  "effectTests": [
    {
      "description": "totalPowerNerf applies after combo calculation",
      "effectType": "totalPowerNerf",
      "timing": "finalCalculation",
      "expectedBehavior": "Power reduced after all other calculations complete"
    }
  ],
  "cardDefinitions": {
    "sp-6": {
      "name": "DeepSeek風暴",
      "cardType": "sp",
      "effects": {
        "description": "在全場總能力結算後，對方的總能力值-80",
        "rules": [
          {
            "id": "deepseek_storm_final_nerf",
            "type": "triggered",
            "trigger": {
              "event": "finalCalculation",
              "conditions": []
            },
            "target": {
              "owner": "opponent",
              "zones": [],
              "filters": []
            },
            "effect": {
              "type": "totalPowerNerf",
              "value": 80
            }
          }
        ]
      }
    },
    "c-2": {
      "name": "前總統特朗普(YMCA)",
      "cardType": "character",
      "gameType": "右翼",
      "power": 80,
      "traits": ["特朗普家族"],
      "effects": {
        "description": "我方場上全部右翼類型的角色卡 原能力值加 +10",
        "rules": [
          {
            "id": "trump_ymca_boost",
            "type": "continuous",
            "trigger": {
              "event": "always",
              "conditions": []
            },
            "target": {
              "owner": "self",
              "zones": ["top", "left", "right"],
              "filters": [
                {
                  "type": "gameType",
                  "value": "右翼"
                }
              ]
            },
            "effect": {
              "type": "powerBoost",
              "value": 10
            }
          }
        ]
      }
    },
    "c-1": {
      "name": "總統特朗普",
      "cardType": "character",
      "gameType": "愛國者",
      "power": 100,
      "traits": ["特朗普家族"],
      "effects": {
        "description": "我方場上全部擁有特朗普家族特徵的角色卡 原能力值加 +10",
        "rules": [
          {
            "id": "trump_president_boost",
            "type": "continuous",
            "trigger": {
              "event": "always",
              "conditions": []
            },
            "target": {
              "owner": "self",
              "zones": ["top", "left", "right"],
              "filters": [
                {
                  "type": "trait",
                  "value": "特朗普家族"
                }
              ]
            },
            "effect": {
              "type": "powerBoost",
              "value": 10
            }
          }
        ]
      }
    },
    "c-3": {
      "name": "德桑蒂斯",
      "cardType": "character",
      "gameType": "右翼",
      "power": 60,
      "traits": ["共和黨"],
      "effects": {
        "description": "No special effects",
        "rules": []
      }
    },
    "c-21": {
      "name": "奧巴馬",
      "cardType": "character",
      "gameType": "左翼",
      "power": 80,
      "traits": ["Deep State"],
      "effects": {
        "description": "所有角色卡原能力值加 +50 (只適用在某一張角色卡上，我方優先)",
        "rules": [
          {
            "id": "obama_single_boost",
            "type": "continuous",
            "trigger": {
              "event": "always",
              "conditions": []
            },
            "target": {
              "owner": "both",
              "zones": ["top", "left", "right"],
              "filters": [],
              "targetCount": 1
            },
            "effect": {
              "type": "powerBoost",
              "value": 50
            }
          }
        ]
      }
    },
    "c-22": {
      "name": "Test Card 22",
      "cardType": "character",
      "gameType": "左翼",
      "power": 60,
      "traits": [],
      "effects": {
        "description": "No special effects",
        "rules": []
      }
    },
    "c-23": {
      "name": "Test Card 23",
      "cardType": "character",
      "gameType": "經濟",
      "power": 65,
      "traits": [],
      "effects": {
        "description": "No special effects",
        "rules": []
      }
    }
  }
}