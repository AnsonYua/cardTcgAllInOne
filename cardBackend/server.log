
> cardbackend@1.0.0 start
> node server.js

Loading DeckManager synchronously...
DeckManager initialized synchronously with 59 total cards
DeckManager already initialized synchronously
Server is running on port 8080
🔧 Initializing injected game state with proper leader sequence...
   🎯 Leaders found in zones but not in play sequence - recording leader plays...
🎯 Recorded PLAY_LEADER: s-1 by playerId_1 in leader (sequence: 1) turn:1 phase:MAIN_PHASE
   ✅ Recorded leader play: s-1 for playerId_1
🎯 Recorded PLAY_LEADER: s-2 by playerId_2 in leader (sequence: 2) turn:1 phase:MAIN_PHASE
   ✅ Recorded leader play: s-2 for playerId_2
   🔄 Running unified effect simulation for all plays...
🎬 Starting unified effect simulation (single source of truth)...
✅ Initialized fieldEffects structure for all players
📋 Replaying 2 plays directly on gameEnv.players[].fieldEffects...
▶️ Executing play 1: PLAY_LEADER s-1 by playerId_1
🏛️ Processing leader s-1 effects for playerId_1 (unified)...
🔒 Applied zone restrictions to playerId_1: {
  TOP: [ '右翼', '自由', '經濟' ],
  LEFT: [ '右翼', '自由', '愛國者' ],
  RIGHT: [ '右翼', '愛國者', '經濟' ],
  HELP: [ 'ALL' ],
  SP: [ 'ALL' ]
}
🔄 Converting old effect format for leader s-1...
🔄 Converted old effect: powerBoost +45 for types: 右翼, 愛國者
🔄 Converted old effect: setPower +0 for types: 經濟
✅ Leader s-1 effects applied to unified structure
🎭 Processing card effects for s-1 (unified)
⚡ Checking triggered effects for s-1 (unified)
▶️ Executing play 2: PLAY_LEADER s-2 by playerId_2
🏛️ Processing leader s-2 effects for playerId_2 (unified)...
🔒 Applied zone restrictions to playerId_2: {
  TOP: [ '左翼', '自由', '經濟', '右翼', '愛國者' ],
  LEFT: [ '左翼', '自由', '經濟', '右翼', '愛國者' ],
  RIGHT: [ '左翼', '自由', '經濟', '右翼', '愛國者' ],
  HELP: [ 'ALL' ],
  SP: [ 'ALL' ]
}
🔄 Converting old effect format for leader s-2...
🔄 Converted old effect: powerBoost +40 for types: 
✅ Leader s-2 effects applied to unified structure
🎭 Processing card effects for s-2 (unified)
⚡ Checking triggered effects for s-2 (unified)
🔢 Calculating final power values (unified)...
📈 Applied power boost +45 to c-1: 100 → 145
✅ Final power calculation completed (unified)
✅ Unified simulation completed - all effects available in gameEnv.players[].fieldEffects
   ✅ Unified effect simulation completed - all effects in gameEnv.players[].fieldEffects
DEBUG: Processing action for playerId_2 in game debug_h2_play_test: PlayCard
DEBUG: Game data loaded successfully
DEBUG: About to call checkIsPlayOkForAction
hand ["h-2"]
DEBUG: checkIsPlayOkForAction result: true
DEBUG: About to call processAction
DEBUG: About to get card details for: h-2
DEBUG: Card details received: {
  id: 'h-2',
  name: 'Make America Great Again',
  cardType: 'help',
  effects: { description: '選擇對方一張角色卡，原能力值 變成 0', rules: [ [Object] ] }
}
DEBUG: Checking 0 help cards for player playerId_2
Invalid card structure in left zone: {
  id: 'c-1',
  name: '總統特朗普',
  cardType: 'character',
  gameType: '愛國者',
  power: 100,
  traits: [ '特朗普家族' ]
}
ERROR in processPlayerAction: Cannot read properties of undefined (reading '0')
Stack trace: TypeError: Cannot read properties of undefined (reading '0')
    at mozGamePlay.checkIsSummonBattleReady (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/mozGame/mozGamePlay.js:817:58)
    at mozGamePlay.checkIsMainPhaseComplete (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/mozGame/mozGamePlay.js:863:51)
    at mozGamePlay.processAction (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/mozGame/mozGamePlay.js:594:52)
    at async GameLogic.processPlayerAction (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/services/GameLogic.js:295:34)
    at async playerAction (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/controllers/gameController.js:43:31)
🔧 Initializing injected game state with proper leader sequence...
   🎯 Leaders found in zones but not in play sequence - recording leader plays...
🎯 Recorded PLAY_LEADER: s-1 by playerId_1 in leader (sequence: 1) turn:1 phase:MAIN_PHASE
   ✅ Recorded leader play: s-1 for playerId_1
🎯 Recorded PLAY_LEADER: s-2 by playerId_2 in leader (sequence: 2) turn:1 phase:MAIN_PHASE
   ✅ Recorded leader play: s-2 for playerId_2
   🔄 Running unified effect simulation for all plays...
🎬 Starting unified effect simulation (single source of truth)...
✅ Initialized fieldEffects structure for all players
📋 Replaying 2 plays directly on gameEnv.players[].fieldEffects...
▶️ Executing play 1: PLAY_LEADER s-1 by playerId_1
🏛️ Processing leader s-1 effects for playerId_1 (unified)...
🔒 Applied zone restrictions to playerId_1: {
  TOP: [ '右翼', '自由', '經濟' ],
  LEFT: [ '右翼', '自由', '愛國者' ],
  RIGHT: [ '右翼', '愛國者', '經濟' ],
  HELP: [ 'ALL' ],
  SP: [ 'ALL' ]
}
🔄 Converting old effect format for leader s-1...
🔄 Converted old effect: powerBoost +45 for types: 右翼, 愛國者
🔄 Converted old effect: setPower +0 for types: 經濟
✅ Leader s-1 effects applied to unified structure
🎭 Processing card effects for s-1 (unified)
⚡ Checking triggered effects for s-1 (unified)
▶️ Executing play 2: PLAY_LEADER s-2 by playerId_2
🏛️ Processing leader s-2 effects for playerId_2 (unified)...
🔒 Applied zone restrictions to playerId_2: {
  TOP: [ '左翼', '自由', '經濟', '右翼', '愛國者' ],
  LEFT: [ '左翼', '自由', '經濟', '右翼', '愛國者' ],
  RIGHT: [ '左翼', '自由', '經濟', '右翼', '愛國者' ],
  HELP: [ 'ALL' ],
  SP: [ 'ALL' ]
}
🔄 Converting old effect format for leader s-2...
🔄 Converted old effect: powerBoost +40 for types: 
✅ Leader s-2 effects applied to unified structure
🎭 Processing card effects for s-2 (unified)
⚡ Checking triggered effects for s-2 (unified)
🔢 Calculating final power values (unified)...
📈 Applied power boost +45 to c-1: 100 → 145
✅ Final power calculation completed (unified)
✅ Unified simulation completed - all effects available in gameEnv.players[].fieldEffects
   ✅ Unified effect simulation completed - all effects in gameEnv.players[].fieldEffects
DEBUG: Processing action for playerId_2 in game debug_h2_play_test: PlayCard
DEBUG: Game data loaded successfully
DEBUG: About to call checkIsPlayOkForAction
hand ["h-2"]
DEBUG: checkIsPlayOkForAction result: true
DEBUG: About to call processAction
DEBUG: About to get card details for: h-2
DEBUG: Card details received: {
  id: 'h-2',
  name: 'Make America Great Again',
  cardType: 'help',
  effects: { description: '選擇對方一張角色卡，原能力值 變成 0', rules: [ [Object] ] }
}
DEBUG: Checking 0 help cards for player playerId_2
Invalid card structure in left zone: {
  id: 'c-1',
  name: '總統特朗普',
  cardType: 'character',
  gameType: '愛國者',
  power: 100,
  traits: [ '特朗普家族' ]
}
ERROR in processPlayerAction: Cannot read properties of undefined (reading '0')
Stack trace: TypeError: Cannot read properties of undefined (reading '0')
    at mozGamePlay.checkIsSummonBattleReady (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/mozGame/mozGamePlay.js:817:58)
    at mozGamePlay.checkIsMainPhaseComplete (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/mozGame/mozGamePlay.js:863:51)
    at mozGamePlay.processAction (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/mozGame/mozGamePlay.js:594:52)
    at async GameLogic.processPlayerAction (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/services/GameLogic.js:295:34)
    at async playerAction (/Users/hello/Desktop/card/unity/cardGameRevamp/cardBackend/src/controllers/gameController.js:43:31)
